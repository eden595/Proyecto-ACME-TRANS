{% extends "reportes/base.html" %}
{% load static %}

{% block title %}Dashboard - ACME TRANS{% endblock %}
{% block page_title %}Panel de Control{% endblock %}

{% block content %}

<div class="kpi-row">
    <div class="kpi-card">
        <h4>Camiones Totales</h4>
        <div class="kpi-value">{{ total_camiones }}</div>
    </div>
    <div class="kpi-card">
        <h4>Camiones en Ruta</h4>
        <div class="kpi-value {% if camiones_en_ruta > 0 %}kpi-danger{% endif %}">{{ camiones_en_ruta }}</div>
    </div>
    <div class="kpi-card">
        <h4>Reportes (Últ. 30 días)</h4>
        <div class="kpi-value">{{ reportes_mes }}</div>
    </div>
    <div class="kpi-card">
        <h4>Gastos (Últ. 30 días)</h4>
        <div class="kpi-value">${{ total_gastos_mes }}</div>
    </div>
</div>

<div class="content-row">

    <div class="content-card-large">
        <h4>Estado de la Flota (Total)</h4>
        <div class="chart-container-pie">
            <canvas id="flotaChart"></canvas>
        </div>
    </div>

    <div class="content-card-large">
        <h4>Gastos por Categoría (Últ. 30 días)</h4>
        <div class="chart-container-pie">
            <canvas id="gastosCategoriaChart"></canvas>
        </div>
    </div>

    <div class="content-card-large">
        <h4>Actividad Reciente (Últimos Reportes)</h4>
        <ul class="activity-list">
            {% for reporte in actividad_reciente %}
            <li>
                <span class="activity-icon">R</span>
                <div class="activity-text">
                    <strong>{{ reporte.centro.nombre }}</strong> envió un reporte 
                    {% if reporte.total_reporte %}
                        por <strong>${{ reporte.total_reporte|floatformat:0 }}</strong>
                    {% else %}
                        (sin gastos)
                    {% endif %}.
                    <span class="activity-time">{{ reporte.fecha|timesince }} atrás</span>
                </div>
            </li>
            {% empty %}
                <li>No hay actividad reciente.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Lectura de Datos (Pasados desde views.py) ---
        const flotaLabels = JSON.parse('{{ flota_labels|safe }}');
        const flotaData = JSON.parse('{{ flota_data|safe }}');
        
        const gastosCatLabels = JSON.parse('{{ gastos_cat_labels|safe }}');
        const gastosCatData = JSON.parse('{{ gastos_cat_data|safe }}');
        // (Datos de 'gastosLine' ELIMINADOS)

        // --- 2. Colores de la Paleta ---
        const colorPrimario = '#0052cc';
        const colorAmarillo = '#ffab00';
        const colorRojo = '#de350b';
        const colorVerde = '#36b37e';
        const colorGris = '#5e6c84';

        // --- 3. Gráfico de Flota (Doughnut) ---
        if (flotaData.length > 0 && document.getElementById('flotaChart')) {
            const ctxFlota = document.getElementById('flotaChart').getContext('2d');
            new Chart(ctxFlota, {
                type: 'doughnut',
                data: {
                    labels: flotaLabels,
                    datasets: [{
                        label: 'Estado de Flota',
                        data: flotaData,
                        backgroundColor: [colorVerde, colorAmarillo, colorRojo],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // <-- AÑADE ESTA LÍNEA
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        // --- 4. Gráfico de Gastos por Categoría (Pie) ---
        if (gastosCatData.length > 0 && document.getElementById('gastosCategoriaChart')) {
            const ctxGastosCat = document.getElementById('gastosCategoriaChart').getContext('2d');
            new Chart(ctxGastosCat, {
                type: 'pie',
                data: {
                    labels: gastosCatLabels,
                    datasets: [{
                        label: 'Gastos por Categoría',
                        data: gastosCatData,
                        backgroundColor: [colorPrimario, colorAmarillo, colorRojo, colorVerde, colorGris],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // <-- AÑADE ESTA LÍNEA
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        // --- (Sección del gráfico "Gastos en el Tiempo" ELIMINADA) ---

    }); // Fin del DOMContentLoaded
</script>

{% endblock %}