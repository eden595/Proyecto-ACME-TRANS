{% extends "reportes/base.html" %}
{% load static %}

{% block title %}Dashboard - ACME TRANS{% endblock %}
{% block page_title %}Panel de Control{% endblock %}

{% block content %}

<div class="row">
    <div class="col-xl-3 col-sm-6 mb-4">
        <div class="card border-radius-xl">
            <div class="card-header p-3 pt-2">
                <div class="icon-shape bg-gradient-dark shadow-dark text-center border-radius-xl mt-n4 position-absolute">
                    <i class="material-icons opacity-10">local_shipping</i>
                </div>
                <div class="text-end pt-1">
                    <p class="text-sm mb-0 text-capitalize">Total Camiones</p>
                    <h4 class="mb-0">{{ total_camiones }}</h4>
                </div>
            </div>
            <hr class="dark horizontal my-0">
            <div class="card-footer p-3">
                <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+0 </span> esta semana</p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-4">
        <div class="card border-radius-xl">
            <div class="card-header p-3 pt-2">
                <div class="icon-shape bg-gradient-primary shadow-primary text-center border-radius-xl mt-n4 position-absolute">
                    <i class="material-icons opacity-10">warning</i>
                </div>
                <div class="text-end pt-1">
                    <p class="text-sm mb-0 text-capitalize">En Ruta</p>
                    <h4 class="mb-0">{{ camiones_en_ruta }}</h4>
                </div>
            </div>
            <hr class="dark horizontal my-0">
            <div class="card-footer p-3">
                <p class="mb-0"><span class="text-sm font-weight-bolder">Activos ahora mismo</span></p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-4">
        <div class="card border-radius-xl">
            <div class="card-header p-3 pt-2">
                <div class="icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
                    <i class="material-icons opacity-10">attach_money</i>
                </div>
                <div class="text-end pt-1">
                    <p class="text-sm mb-0 text-capitalize">Gastos (30 días)</p>
                    <h4 class="mb-0">${{ total_gastos_mes }}</h4>
                </div>
            </div>
            <hr class="dark horizontal my-0">
            <div class="card-footer p-3">
                <p class="mb-0">Registrados este mes</p>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-4">
        <div class="card border-radius-xl">
            <div class="card-header p-3 pt-2">
                <div class="icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
                    <i class="material-icons opacity-10">receipt</i>
                </div>
                <div class="text-end pt-1">
                    <p class="text-sm mb-0 text-capitalize">Reportes</p>
                    <h4 class="mb-0">{{ reportes_mes }}</h4>
                </div>
            </div>
            <hr class="dark horizontal my-0">
            <div class="card-footer p-3">
                <p class="mb-0">Últimos 30 días</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    
    <div class="col-lg-8 col-md-12">
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card z-index-2 border-radius-xl h-100">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                        <div class="bg-gradient-dark shadow-dark chart-container-header border-radius-xl">
                            <canvas id="flotaChart" height="200"></canvas>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-0">Estado de la Flota</h6>
                        <p class="text-sm">Disponibilidad actual</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card z-index-2 border-radius-xl h-100">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                        <div class="bg-gradient-dark shadow-dark chart-container-header border-radius-xl">
                            <canvas id="gastosCategoriaChart" height="200"></canvas>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-0">Gastos por Categoría</h6>
                        <p class="text-sm">Últimos 30 días</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="card z-index-2 border-radius-xl">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
                        <div class="bg-gradient-dark shadow-dark border-radius-xl py-3 pe-1">
                            <div class="chart">
                                <canvas id="chart-line" class="chart-canvas" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="mb-0">Evolución Diaria de Gastos</h6>
                        <p class="text-sm">Tendencia de los últimos 30 días</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-12 mb-4">
        <div class="card h-100 border-radius-xl">
            <div class="card-header pb-0">
                <h6>Actividad Reciente</h6>
            </div>
            <div class="card-body p-3">
                <div class="timeline timeline-one-side">
                    {% for reporte in actividad_reciente %}
                    <div class="d-flex mb-3">
                        <div class="me-3">
                             <i class="material-icons text-info text-gradient">notifications</i>
                        </div>
                        <div>
                            <h6 class="text-dark text-sm font-weight-bold mb-0">Reporte de {{ reporte.centro.nombre }}</h6>
                            <p class="text-secondary text-xs mt-1 mb-0">{{ reporte.fecha|timesince }} atrás</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-center">No hay actividad reciente.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const flotaLabels = JSON.parse('{{ flota_labels|safe }}');
        const flotaData = JSON.parse('{{ flota_data|safe }}');
        const gastosCatLabels = JSON.parse('{{ gastos_cat_labels|safe }}');
        const gastosCatData = JSON.parse('{{ gastos_cat_data|safe }}');
        const lineLabels = JSON.parse('{{ gastos_line_labels|safe }}');
        const lineData = JSON.parse('{{ gastos_line_data|safe }}');

        // Configuración común para leyendas
        const commonLegendOptions = {
            display: true,
            position: 'bottom',
            align: 'center',
            labels: {
                color: '#fff', 
                boxWidth: 12,
                usePointStyle: true, 
                pointStyle: 'circle',
                padding: 20,
                font: { size: 11, family: "'Roboto', sans-serif" }
            }
        };

        // 1. GRÁFICO DE LÍNEA (ROJA Y FONDO NEGRO)
        if (document.getElementById('chart-line')) {
            var ctxLine = document.getElementById("chart-line").getContext("2d");
            new Chart(ctxLine, {
                type: "line",
                data: {
                    labels: lineLabels,
                    datasets: [{
                        label: "Gastos ($)",
                        tension: 0.4,
                        borderWidth: 0,
                        pointRadius: 5,
                        pointBackgroundColor: "rgba(255, 255, 255, .8)",
                        pointBorderColor: "transparent",
                        borderColor: "#F44336", // Línea ROJA
                        borderWidth: 4,
                        backgroundColor: "rgba(244, 67, 54, 0.2)", // Sombra ROJA suave
                        fill: true,
                        data: lineData,
                        maxBarThickness: 6
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            grid: {
                                drawBorder: false, display: true, drawOnChartArea: true, drawTicks: false,
                                borderDash: [5, 5], color: 'rgba(255, 255, 255, .2)'
                            },
                            ticks: {
                                display: true, padding: 10, color: '#f8f9fa',
                                font: { size: 14, weight: 300, family: "Roboto", style: 'normal', lineHeight: 2 },
                            }
                        },
                        x: {
                            grid: { drawBorder: false, display: false, drawOnChartArea: false, drawTicks: false, borderDash: [5, 5] },
                            ticks: { display: true, color: '#f8f9fa', padding: 10, font: { size: 14, weight: 300, family: "Roboto", style: 'normal', lineHeight: 2 } }
                        },
                    },
                },
            });
        }

        // 2. GRÁFICO FLOTA
        if (flotaData.length > 0 && document.getElementById('flotaChart')) {
            const ctxFlota = document.getElementById('flotaChart').getContext('2d');
            new Chart(ctxFlota, {
                type: 'doughnut',
                data: {
                    labels: flotaLabels,
                    datasets: [{
                        data: flotaData,
                        backgroundColor: ['#4CAF50', '#FF9800', '#F44336'], 
                        borderWidth: 0,
                        weight: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 10 },
                    cutout: '60%',
                    plugins: { legend: commonLegendOptions }
                }
            });
        }
        
        // 3. GRÁFICO GASTOS
        if (gastosCatData.length > 0 && document.getElementById('gastosCategoriaChart')) {
            const ctxGastos = document.getElementById('gastosCategoriaChart').getContext('2d');
            new Chart(ctxGastos, {
                type: 'pie',
                data: {
                    labels: gastosCatLabels,
                    datasets: [{
                        data: gastosCatData,
                        backgroundColor: ['#EC407A', '#26C6DA', '#66BB6A', '#FFA726', '#d2d6de'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 10 },
                    plugins: { legend: commonLegendOptions }
                }
            });
        }
    });
</script>

{% endblock %}